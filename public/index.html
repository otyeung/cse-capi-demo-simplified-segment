<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Meta Tags -->
    <meta charset="utf-8" />
    <link rel="icon" href="%PUBLIC_URL%/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>LinkedIn Online CAPI Demo for Segment</title>

    <!-- Set 1P Cookie BEFORE Segment loads -->
    <script>
      if (!document.cookie.includes('ivid=')) {
        document.cookie =
          'ivid=1cf6a0db-e689-42dc-984e-9f089057f71d; path=/; max-age=31536000; SameSite=Lax'
      }
    </script>

    <script>
      !(function () {
        var i = 'analytics',
          analytics = (window[i] = window[i] || [])
        if (!analytics.initialize)
          if (analytics.invoked)
            window.console &&
              console.error &&
              console.error('Segment snippet included twice.')
          else {
            analytics.invoked = !0
            analytics.methods = [
              'trackSubmit',
              'trackClick',
              'trackLink',
              'trackForm',
              'pageview',
              'identify',
              'reset',
              'group',
              'track',
              'ready',
              'alias',
              'debug',
              'page',
              'screen',
              'once',
              'off',
              'on',
              'addSourceMiddleware',
              'addIntegrationMiddleware',
              'setAnonymousId',
              'addDestinationMiddleware',
              'register',
            ]
            analytics.factory = function (e) {
              return function () {
                if (window[i].initialized)
                  return window[i][e].apply(window[i], arguments)
                var n = Array.prototype.slice.call(arguments)
                if (
                  [
                    'track',
                    'screen',
                    'alias',
                    'group',
                    'page',
                    'identify',
                  ].indexOf(e) > -1
                ) {
                  var c = document.querySelector("link[rel='canonical']")
                  n.push({
                    __t: 'bpc',
                    c: (c && c.getAttribute('href')) || void 0,
                    p: location.pathname,
                    u: location.href,
                    s: location.search,
                    t: document.title,
                    r: document.referrer,
                  })
                }
                n.unshift(e)
                analytics.push(n)
                return analytics
              }
            }
            for (var n = 0; n < analytics.methods.length; n++) {
              var key = analytics.methods[n]
              analytics[key] = analytics.factory(key)
            }
            analytics.load = function (key, n) {
              var t = document.createElement('script')
              t.type = 'text/javascript'
              t.async = !0
              t.setAttribute('data-global-segment-analytics-key', i)
              t.src =
                'https://cdn.segment.com/analytics.js/v1/' +
                key +
                '/analytics.min.js'
              var r = document.getElementsByTagName('script')[0]
              r.parentNode.insertBefore(t, r)
              analytics._loadOptions = n
            }
            analytics._writeKey = 'a9R3kH9eo5VIZfFEXnhcXjWptvWuhAfS'
            analytics.SNIPPET_VERSION = '5.2.0'
            analytics.load('a9R3kH9eo5VIZfFEXnhcXjWptvWuhAfS')
          }
      })()
    </script>

    <script>
      function getCookie(name) {
        const value = `; ${document.cookie}`
        const parts = value.split(`; ${name}=`)
        if (parts.length === 2) return parts.pop().split(';').shift()
        return null
      }

      function waitForSegment(cb) {
        if (window.analytics && analytics.addSourceMiddleware) {
          cb()
        } else {
          setTimeout(() => waitForSegment(cb), 50)
        }
      }

      waitForSegment(() => {
        console.log('[DEBUG] Setting up Segment middleware for 1P cookies')

        analytics.addSourceMiddleware(({ payload, next }) => {
          const props = payload.obj.properties || payload.obj.traits || {}
          const li_fat_id = getCookie('li_fat_id')
          const ivid = getCookie('ivid')
          const timestamp = Date.now()

          console.log('[DEBUG] Middleware adding cookies:', { li_fat_id, ivid, timestamp })

          next({
            ...payload,
            obj: {
              ...payload.obj,
              properties: {
                ...props,
                li_fat_id: li_fat_id,
                ivid: ivid,
                timestamp: timestamp,
              },
              ...(payload.obj.traits
                ? {
                    traits: {
                      ...payload.obj.traits,
                      li_fat_id: li_fat_id,
                      ivid: ivid,
                    },
                  }
                : {}),
            },
          })
        })

        console.log('[DEBUG] Middleware registered, calling analytics.page()')
        analytics.page()
      })
    </script>
  </head>

  <body>
    <noscript>You need to enable JavaScript to run this app.</noscript>

    <div id="root"></div>

    <!-- LinkedIn Insight Tag -->
    <script type="text/javascript">
      _linkedin_partner_id = '5806284'
      window._linkedin_data_partner_ids =
        window._linkedin_data_partner_ids || []
      window._linkedin_data_partner_ids.push(_linkedin_partner_id)
    </script>

    <script type="text/javascript">
      ;(function (l) {
        if (!l) {
          window.lintrk = function (a, b) {
            window.lintrk.q.push([a, b])
          }
          window.lintrk.q = []
        }
        var s = document.getElementsByTagName('script')[0]
        var b = document.createElement('script')
        b.type = 'text/javascript'
        b.async = true
        b.src = 'https://snap.licdn.com/li.lms-analytics/insight.min.js'
        s.parentNode.insertBefore(b, s)
      })(window.lintrk)
    </script>

    <noscript>
      <img
        height="1"
        width="1"
        style="display: none"
        alt=""
        src="https://px.ads.linkedin.com/collect/?pid=5806284&fmt=gif"
      />
    </noscript>
  </body>
</html>
