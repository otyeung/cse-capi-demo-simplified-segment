<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Meta Tags -->
    <meta charset="utf-8" />
    <link rel="icon" href="%PUBLIC_URL%/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />
    <meta
      name="description"
      content="Web site created using create-react-app"
    />
    <link rel="apple-touch-icon" href="%PUBLIC_URL%/apple-touch-icon.png" />
    <link rel="manifest" href="%PUBLIC_URL%/manifest.json" />

    <!-- Page Title -->
    <title>LinkedIn Online CAPI Demo for Segment</title>

    <!-- Segment Analytics -->
    <script>
      !(function () {
        var i = 'analytics',
          analytics = (window[i] = window[i] || [])
        if (!analytics.initialize)
          if (analytics.invoked)
            console.error('Segment snippet included twice.')
          else {
            analytics.invoked = true
            analytics.methods = [
              'trackSubmit',
              'trackClick',
              'trackLink',
              'trackForm',
              'pageview',
              'identify',
              'reset',
              'group',
              'track',
              'ready',
              'alias',
              'debug',
              'page',
              'screen',
              'once',
              'off',
              'on',
              'addSourceMiddleware',
              'addIntegrationMiddleware',
              'setAnonymousId',
              'addDestinationMiddleware',
              'register',
            ]
            analytics.factory = function (e) {
              return function () {
                if (window[i].initialized)
                  return window[i][e].apply(window[i], arguments)
                var n = Array.prototype.slice.call(arguments)
                n.unshift(e)
                analytics.push(n)
                return analytics
              }
            }
            for (var n = 0; n < analytics.methods.length; n++) {
              analytics[analytics.methods[n]] = analytics.factory(
                analytics.methods[n]
              )
            }
            analytics.load = function (key, n) {
              var t = document.createElement('script')
              t.type = 'text/javascript'
              t.async = true
              t.src =
                'https://cdn.segment.com/analytics.js/v1/' +
                key +
                '/analytics.min.js'
              var r = document.getElementsByTagName('script')[0]
              r.parentNode.insertBefore(t, r)
              analytics._loadOptions = n
            }
            analytics.load('a9R3kH9eo5VIZfFEXnhcXjWptvWuhAfS')
          }
      })()
    </script>

    <!-- Register plugin ONLY AFTER Segment snippet -->
    <script>
      function getCookie(name) {
        const value = `; ${document.cookie}`
        const parts = value.split(`; ${name}=`)
        if (parts.length === 2) return parts.pop().split(';').shift()
        return null
      }

      // Wait for Segment to fully load, then register plugin
      analytics.ready(() => {
        analytics.register({
          name: 'capture-first-party-cookies',
          version: '1.0.0',
          type: 'before',

          isLoaded() {
            return true
          },
          load() {
            return Promise.resolve()
          },

          async page(ctx) {
            ctx.update({
              properties: {
                ...ctx.properties,
                li_fat_id: getCookie('li_fat_id'),
                ivid: getCookie('ivid'),
              },
            })
            return ctx
          },

          async track(ctx) {
            ctx.update({
              properties: {
                ...ctx.properties,
                li_fat_id: getCookie('li_fat_id'),
                ivid: getCookie('ivid'),
              },
            })
            return ctx
          },
        })

        // Fire page call AFTER plugin loaded â†’ attaches cookies
        analytics.page()
      })
    </script>
  </head>

  <body>
    <!-- NoScript Message -->
    <noscript>You need to enable JavaScript to run this app.</noscript>

    <!-- Root Container for Web Application -->
    <div id="root"></div>

    <!-- Set 1P Cookie on Page Load -->
    <script type="text/javascript">
      document.cookie =
        'ivid=1cf6a0db-e689-42dc-984e-9f089057f71d; path=/; max-age=31536000; SameSite=Lax'
    </script>

    <!-- LinkedIn Insight Tag -->
    <script type="text/javascript">
      _linkedin_partner_id = '5806284'
      window._linkedin_data_partner_ids =
        window._linkedin_data_partner_ids || []
      window._linkedin_data_partner_ids.push(_linkedin_partner_id)
    </script>
    <script type="text/javascript">
      ;(function (l) {
        if (!l) {
          window.lintrk = function (a, b) {
            window.lintrk.q.push([a, b])
          }
          window.lintrk.q = []
        }
        var s = document.getElementsByTagName('script')[0]
        var b = document.createElement('script')
        b.type = 'text/javascript'
        b.async = true
        b.src = 'https://snap.licdn.com/li.lms-analytics/insight.min.js'
        s.parentNode.insertBefore(b, s)
      })(window.lintrk)
    </script>
    <noscript>
      <img
        height="1"
        width="1"
        style="display: none"
        alt=""
        src="https://px.ads.linkedin.com/collect/?pid=5806284&fmt=gif"
      />
    </noscript>
  </body>
</html>
